原文链接：http://www.cnblogs.com/codingbigdog/archive/2022/07/26/16522384.html
提交日期：Tue, 26 Jul 2022 11:51:00 GMT
博文内容：

                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>参考：<a href="https://zhuanlan.zhihu.com/p/34587739">CUDA编程原理1</a><br> <a href="https://www.cnblogs.com/skyfsm/p/9673960.html">CUDA编程原理2</a><br> <a href="https://www.cnblogs.com/wildkid1024/p/14878125.html#:~:text=%5BCUDA%5DCUDA%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98%E5%9B%9B%E2%80%94%E2%80%94%E7%9F%A9%E9%98%B5%E4%B9%98%E6%B3%95,%E7%9F%A9%E9%98%B5%E4%B9%98%E6%B3%95%E6%98%AF%E6%9C%80%E5%B8%B8%E8%A7%81%E7%9A%84%E6%93%8D%E4%BD%9C%EF%BC%8C%E7%8E%B0%E4%BB%A3%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84%E5%9F%BA%E7%A1%80%E4%BE%BF%E6%98%AF%E7%9F%A9%E9%98%B5%E4%B9%98%E6%B3%95%E3%80%82%20%E4%B8%80%E4%B8%AAN*M%E7%9A%84%E7%9F%A9%E9%98%B5%EF%BC%8C%E4%B9%98%E4%BB%A5%E4%B8%80%E4%B8%AAM*P%E7%9A%84%E7%9F%A9%E9%98%B5%EF%BC%8C%E5%BE%97%E5%88%B0N*P%E7%9A%84%E7%9F%A9%E9%98%B5%EF%BC%8C%E7%9F%A9%E9%98%B5%E4%B9%98%E6%B3%95%E5%8D%B3%E4%B8%BA%E5%B0%86%E6%AF%8F%E4%B8%80%E8%A1%8C%E4%B8%8E%E8%A2%AB%E4%B9%98%E7%9F%A9%E9%98%B5%E5%AF%B9%E5%BA%94%E5%88%97%E8%BF%9B%E8%A1%8C%E4%B9%98%E5%8A%A0%EF%BC%8C%E6%9C%80%E5%90%8E%E5%B0%86%E6%89%80%E6%9C%89%E7%BB%93%E6%9E%9C%E8%BF%9B%E8%A1%8C%E6%B1%87%E6%80%BB%E3%80%82">矩阵乘法</a></p> 
<p>我们用host指代CPU及其内存，而用device指代GPU及其内存。</p> 
<ul><li><strong>global</strong>：在device上执行，从host中调用（一些特定的GPU也可以从device上调用），返回类型必须是void，不支持可变参数参数，不能成为类成员函数。注意用__global__定义的kernel是异步的，这意味着host不会等待kernel执行完就执行下一步。</li><li><strong>device</strong>：在device上执行，单仅可以从device中调用，不可以和__global__同时用。</li><li><strong>host</strong>：在host上执行，仅可以从host上调用，一般省略不写，不可以和__global__同时用，但可和__device__，此时函数会在device和host都编译。</li></ul> 
<p>1.CUDA的整体结构<br> kernel是在device上线程中并行执行的函数，核函数用__global__符号声明，在调用时需要用&lt;&lt;&lt;grid, block&gt;&gt;&gt;来指定kernel要运行的线程，在CUDA中，每一个线程都要执行核函数。kernel在device上执行时实际上是启动很多线程，一个kernel所启动的所有线程称为一个网格（grid），同一个网格上的线程共享相同的全局内存空间。每一个grid由多个block组成，每一个block由多个线程组成。<br> <img src="https://img-blog.csdnimg.cn/191a12e86d854fbea3a6cce059786631.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAcXFfNDI3NzU5Mzg=,size_10,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> 从上图可以看出每一个block可以组织成三维的，但其实block可以1维、2维或3维组织。Grid可以1维、2维组织。<br> 2.CUDA内存模型<br> 如下图所示。可以看到，每个线程有自己的私有本地内存（Local Memory），而每个线程块有包含共享内存（Shared Memory）,可以被线程块中所有线程共享，其生命周期与线程块一致。此外，所有的线程都可以访问全局内存（Global Memory）。还可以访问一些只读内存块：常量内存（Constant Memory）和纹理内存（Texture Memory）。<br> <img src="https://img-blog.csdnimg.cn/c17932f84c5343c7bcacd865720571f9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAcXFfNDI3NzU5Mzg=,size_18,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> 3. Streaming Multiprocessor，SM<br> SM是GPU的处理器，SM可以并发地执行数百个线程。</p> 
<ul><li>当一个kernel被执行时，它的gird中的线程块被分配到SM上，一个线程块只能在一个SM上被调度。</li><li>SM一般可以调度多个线程块，一个kernel的各个线程块可能被分配多个SM。</li><li>当线程块被划分到某个SM上时，它将被进一步划分为多个线程束（一个线程束包含32个线程），因为这才是SM的基本执行单元，但是一个SM同时并发的线程束数是有限的</li><li>由于SM的基本执行单元是包含32个线程的线程束，所以block大小一般要设置为32的倍数。</li></ul> 
<p>SM中包含多个SP，一个GPU可以有多个SM（比如16个），最终一个GPU可能包含有上千个SP。<br> 每个线程由每个线程处理器（SP）执行<br> 线程块由多核处理器（SM）执行<br> 一个kernel其实由一个grid来执行，一个kernel一次只能在一个GPU上执行<br> <img src="https://img-blog.csdnimg.cn/90530edb1a8b4899a2be5d21956b2a9c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAcXFfNDI3NzU5Mzg=,size_8,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> block是软件概念，一个block只会由一个sm调度，程序员在开发时，通过设定block的属性，告诉GPU硬件，我有多少个线程，线程怎么组织。而具体怎么调度由sm的warps scheduler负责，block一旦被分配好SM，该block就会一直驻留在该SM中，直到执行结束。一个SM可以同时拥有多个blocks，但需要序列执行</p> 
<p>4.cuda编程的相关函数</p> 
<ul><li>在device上申请一定字节大小的显存:</li></ul> 
<pre><code class="prism language-cpp"> <span class="token function">cudaMalloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span> devPtr<span class="token punctuation">,</span> size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在device上申请一定字节大小的显存</span>
 <span class="token comment">// devPtr是指向所分配内存的指针 </span>
 <span class="token comment">// 与cudaFree函数配合使用</span>
</code></pre> 
<ul><li>内存和显存之间的数据拷贝：</li></ul> 
<pre><code class="prism language-cpp"><span class="token function">cudaMemcpy</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> dst<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> src<span class="token punctuation">,</span> size_t count<span class="token punctuation">,</span> cudaMemcpyKind kind<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>src指向数据源，而dst是目标区域，count是复制的字节数，其中kind控制复制的方向：cudaMemcpyHostToHost, cudaMemcpyHostToDevice, cudaMemcpyDeviceToHost及cudaMemcpyDeviceToDevice，如cudaMemcpyHostToDevice将host上数据拷贝到device上。</p> 
<ul><li>获取线程的id<br> 我们可以用dim3类来表示网格和线程块的组织方式，网格grid可以表示为一维和二维格式，线程块block可以表示为一维、二维和三维的数据格式。</li></ul> 
<pre><code class="prism language-cpp">dim3 <span class="token function">DimGrid</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//5000个线程块，维度是100*50</span>
dim3 <span class="token function">DimBlock</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//每个线层块内包含256个线程，线程块内的维度是4*8*8**</span>
</code></pre> 
<p>最常见的组织方式如下：</p> 
<pre><code class="prism language-cpp">dim3 <span class="token function">dimGrid</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span>
dim3 <span class="token function">dimBlock</span><span class="token punctuation">(</span>P<span class="token punctuation">,</span> Q<span class="token punctuation">)</span><span class="token punctuation">;</span>
threadId<span class="token punctuation">.</span>x <span class="token operator">=</span> blockIdx<span class="token punctuation">.</span>x<span class="token operator">*</span>blockDim<span class="token punctuation">.</span>x<span class="token operator">+</span>threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span> <span class="token comment">// x轴方向上的id号</span>
threadId<span class="token punctuation">.</span>y <span class="token operator">=</span> blockIdx<span class="token punctuation">.</span>y<span class="token operator">*</span>blockDim<span class="token punctuation">.</span>y<span class="token operator">+</span>threadIdx<span class="token punctuation">.</span>y<span class="token punctuation">;</span> <span class="token comment">// y轴方向上的id号</span>
</code></pre> 
<p>5.实现矩阵乘法</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"cuda_runtime.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"device_launch_parameters.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;ctime&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;ctime&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;math.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"malloc.h"</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>


<span class="token keyword">const</span> <span class="token keyword">int</span> Row <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">;</span> <span class="token comment">// 行数</span>
<span class="token keyword">const</span> <span class="token keyword">int</span> Col <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">;</span> <span class="token comment">// 列数</span>

__global__
<span class="token keyword">void</span> <span class="token function">matrix_mul_gpu</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>M<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> N<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> P<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">)</span> <span class="token comment">// width代表列数</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> i <span class="token operator">=</span> threadIdx<span class="token punctuation">.</span>x <span class="token operator">+</span> blockDim<span class="token punctuation">.</span>x <span class="token operator">*</span> blockIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span> <span class="token comment">// 第i列的线程</span>
	<span class="token keyword">int</span> j <span class="token operator">=</span> threadIdx<span class="token punctuation">.</span>y <span class="token operator">+</span> blockDim<span class="token punctuation">.</span>y <span class="token operator">*</span> blockIdx<span class="token punctuation">.</span>y<span class="token punctuation">;</span> <span class="token comment">// 第j行的线程</span>

	<span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span> a <span class="token operator">=</span> M<span class="token punctuation">[</span>j<span class="token operator">*</span>width <span class="token operator">+</span> k<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 第j行的某一个值</span>
		<span class="token keyword">int</span> b <span class="token operator">=</span> N<span class="token punctuation">[</span>k<span class="token operator">*</span>width <span class="token operator">+</span> i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 第i列的某一个值</span>
		sum <span class="token operator">+=</span> a <span class="token operator">*</span> b<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	P<span class="token punctuation">[</span>j<span class="token operator">*</span>width <span class="token operator">+</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> sum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">matrix_mul_cpu</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>M<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> N<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> P<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">int</span> a <span class="token operator">=</span> M<span class="token punctuation">[</span>i<span class="token operator">*</span>width <span class="token operator">+</span> k<span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token keyword">int</span> b <span class="token operator">=</span> N<span class="token punctuation">[</span>k<span class="token operator">*</span>width <span class="token operator">+</span> j<span class="token punctuation">]</span><span class="token punctuation">;</span>
				sum <span class="token operator">+=</span> a <span class="token operator">*</span> b<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			P<span class="token punctuation">[</span>i<span class="token operator">*</span>width <span class="token operator">+</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> sum<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	clock_t GPUstart<span class="token punctuation">,</span> GPUend<span class="token punctuation">,</span> GPUresult<span class="token punctuation">;</span>

	<span class="token keyword">int</span> <span class="token operator">*</span>A <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> Row <span class="token operator">*</span> Col<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token operator">*</span>B <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> Row <span class="token operator">*</span> Col<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token operator">*</span>C <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> Row <span class="token operator">*</span> Col<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//malloc device memory</span>
	<span class="token keyword">int</span> <span class="token operator">*</span>d_dataA<span class="token punctuation">,</span> <span class="token operator">*</span>d_dataB<span class="token punctuation">,</span> <span class="token operator">*</span>d_dataC<span class="token punctuation">;</span>
	<span class="token function">cudaMalloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>d_dataA<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>Row<span class="token operator">*</span>Col<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">cudaMalloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>d_dataB<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>Row<span class="token operator">*</span>Col<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">cudaMalloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>d_dataC<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>Row<span class="token operator">*</span>Col<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//set value</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Row<span class="token operator">*</span>Col<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		A<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">90</span><span class="token punctuation">;</span>
		B<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	GPUstart <span class="token operator">=</span> <span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">cudaMemcpy</span><span class="token punctuation">(</span>d_dataA<span class="token punctuation">,</span> A<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> Row <span class="token operator">*</span> Col<span class="token punctuation">,</span> cudaMemcpyHostToDevice<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">cudaMemcpy</span><span class="token punctuation">(</span>d_dataB<span class="token punctuation">,</span> B<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> Row <span class="token operator">*</span> Col<span class="token punctuation">,</span> cudaMemcpyHostToDevice<span class="token punctuation">)</span><span class="token punctuation">;</span>
	dim3 <span class="token function">threadPerBlock</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// (Col + threadPerBlock.x - 1)/threadPerBlock.x=Col/threadPerBlock.x+1，即多拿一个block来装不能整除的部分</span>
	dim3 <span class="token function">blockNumber</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Col <span class="token operator">+</span> threadPerBlock<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> threadPerBlock<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span>Row <span class="token operator">+</span> threadPerBlock<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> threadPerBlock<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Block(%d,%d)   Grid(%d,%d).\n"</span><span class="token punctuation">,</span> threadPerBlock<span class="token punctuation">.</span>x<span class="token punctuation">,</span> threadPerBlock<span class="token punctuation">.</span>y<span class="token punctuation">,</span> blockNumber<span class="token punctuation">.</span>x<span class="token punctuation">,</span> blockNumber<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 每一个线程进行某行乘某列的计算，得到结果中的一个元素。也就是d_dataC中的每一个计算结果都和GPU中线程的布局&lt;blockNumber, threadPerBlock &gt;一致</span>
	matrix_mul_gpu <span class="token operator">&lt;&lt;</span> <span class="token operator">&lt;</span>blockNumber<span class="token punctuation">,</span> threadPerBlock <span class="token operator">&gt;&gt;</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span>d_dataA<span class="token punctuation">,</span> d_dataB<span class="token punctuation">,</span> d_dataC<span class="token punctuation">,</span> Col<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//拷贝计算数据-一级数据指针</span>
	<span class="token function">cudaMemcpy</span><span class="token punctuation">(</span>C<span class="token punctuation">,</span> d_dataC<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> Row <span class="token operator">*</span> Col<span class="token punctuation">,</span> cudaMemcpyDeviceToHost<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//释放内存</span>
	<span class="token function">free</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>B<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>C<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">cudaFree</span><span class="token punctuation">(</span>d_dataA<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">cudaFree</span><span class="token punctuation">(</span>d_dataB<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">cudaFree</span><span class="token punctuation">(</span>d_dataC<span class="token punctuation">)</span><span class="token punctuation">;</span>

	GPUend <span class="token operator">=</span> <span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> GPUtime <span class="token operator">=</span> GPUend <span class="token operator">-</span> GPUstart<span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"GPU运行时间：%d\n"</span><span class="token punctuation">,</span> GPUtime <span class="token punctuation">)</span><span class="token punctuation">;</span>

	
	<span class="token comment">// CPU计算</span>
	clock_t CPUstart<span class="token punctuation">,</span> CPUend<span class="token punctuation">,</span> CPUresult<span class="token punctuation">;</span>

	<span class="token keyword">int</span> <span class="token operator">*</span>A2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> Row <span class="token operator">*</span> Col<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token operator">*</span>B2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> Row <span class="token operator">*</span> Col<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token operator">*</span>C2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> Row <span class="token operator">*</span> Col<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//set value</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Row<span class="token operator">*</span>Col<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		A2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">90</span><span class="token punctuation">;</span>
		B2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	CPUstart <span class="token operator">=</span> <span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">matrix_mul_cpu</span><span class="token punctuation">(</span>A2<span class="token punctuation">,</span> B2<span class="token punctuation">,</span> C2<span class="token punctuation">,</span> Col<span class="token punctuation">)</span><span class="token punctuation">;</span>
	CPUend <span class="token operator">=</span> <span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> CPUtime <span class="token operator">=</span> CPUend <span class="token operator">-</span> CPUstart<span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"CPU运行时间：%d\n"</span><span class="token punctuation">,</span> CPUtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"加速比为：%lf\n"</span><span class="token punctuation">,</span><span class="token keyword">double</span><span class="token punctuation">(</span>CPUtime<span class="token punctuation">)</span><span class="token operator">/</span>GPUtime<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>【注】.cu文件好像只能以英文命名，不然可能出错</p>
                